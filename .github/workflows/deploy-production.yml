name: Deploy to Production
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
      - name: Install pnpm
        uses: pnpm/action-setup@v4
      - name: Install dependencies
        run: pnpm install
      - name: Lint
        run: pnpm lint
      - name: Type check
        run: pnpm check-types

  deploy-api:
    needs: ci
    environment: production
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
      - name: Install pnpm
        uses: pnpm/action-setup@v4
      - name: Install dependencies
        run: pnpm install
      - name: Run database migrations
        working-directory: apps/api
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: pnpm db:migrate
      - name: Deploy API to Cloudflare workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: apps/api
          command: deploy --env production
          secrets: |
            DATABASE_URL
            BETTER_AUTH_SECRET
            BETTER_AUTH_URL
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET }}
          BETTER_AUTH_URL: ${{ secrets.BETTER_AUTH_URL }}
      - name: Smoke test
        run: |
          sleep 10
          curl -f https://intent-expense-tracker-production.sebastianiv21.workers.dev/health || exit 1

  notify:
    needs: deploy-api
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Notify Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        uses: Ilshidur/action-discord@master
        with:
          args: |
            üöÄ **Production Deployment**

            üîó **API**: https://intent-expense-tracker-production.sebastianiv21.workers.dev
            üîó **Web**: https://intent.luisibarra.dev

            Status: ${{ needs.deploy-api.result == 'success' && '‚úÖ Success' || '‚ùå Failed' }}
            Commit: ${{ github.sha }}
            Actor: ${{ github.actor }}
            Duration: ${{ needs.deploy-api.duration }}
